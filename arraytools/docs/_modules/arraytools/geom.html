

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arraytools.geom &mdash; arraytools 0.9 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> arraytools
          

          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">arraytools... :</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arraytools_mods.html">Modules in arraytools</a></li>
</ul>
<p class="caption"><span class="caption-text">Sphinx...:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Sphinx_documentation.html">How to document Sphinx</a></li>
</ul>
<p class="caption"><span class="caption-text">ReStructuredText...:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../md_tester.html">Documentation tips</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">arraytools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>arraytools.geom</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arraytools.geom</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">geom</span>
<span class="sd">====</span>

<span class="sd">Script :   geom.py</span>

<span class="sd">Author :   Dan_Patterson@carleton.ca</span>

<span class="sd">Modified : 2019-01-01</span>

<span class="sd">Purpose :  tools for working with numpy arrays and geometry</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">  Do not rely on the OBJECTID field for anything</span>
<span class="sd">  http://support.esri.com/en/technical-article/000010834</span>

<span class="sd">  When working with large coordinates, you should check to see whether a</span>
<span class="sd">  translation about the origin (array - centre) produces different results.</span>
<span class="sd">  This has been noted when calculating area using projected coordinates for the</span>
<span class="sd">  Ontario.npy file.  The difference isn&#39;t huge, but subtracting the centre or</span>
<span class="sd">  minimum from the coordinates produces area values which are equal but differ</span>
<span class="sd">  slightly from those using the unaltered coordinates.</span>

<span class="sd">Included in this module::</span>

<span class="sd">    &#39;__all__&#39;, &#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;,</span>
<span class="sd">    &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;_arrs_&#39;, &#39;_convert&#39;,</span>
<span class="sd">    &#39;_demo&#39;, &#39;_densify_2D&#39;, &#39;_flat_&#39;, &#39;_new_view_&#39;, &#39;_reshape_&#39;, &#39;_test&#39;,</span>
<span class="sd">    &#39;_unpack&#39;, &#39;_view_&#39;, &#39;adjacency_edge&#39;, &#39;angle_2pnts&#39;, &#39;angle_between&#39;,</span>
<span class="sd">    &#39;angle_np&#39;, &#39;angle_seq&#39;, &#39;angles_poly&#39;, &#39;areas&#39;, &#39;as_strided&#39;, &#39;azim_np&#39;,</span>
<span class="sd">    &#39;center_&#39;, &#39;centers&#39;, &#39;centroid_&#39;, &#39;centroids&#39;, &#39;convex&#39;,</span>
<span class="sd">    &#39;cross&#39;, &#39;dedent&#39;, &#39;densify&#39;, &#39;dist_bearing&#39;, &#39;dx_dy_np&#39;, &#39;e_2d&#39;,</span>
<span class="sd">    &#39;e_area&#39;, &#39;e_dist&#39;, &#39;e_leng&#39;, &#39;extent_&#39;, &#39;fill_diagonal&#39;, &#39;ft&#39;,</span>
<span class="sd">    &#39;intersect_pnt&#39;, &#39;knn&#39;, &#39;lengths&#39;, &#39;line_dir&#39;, &#39;max_&#39;,</span>
<span class="sd">    &#39;min_&#39;, &#39;nn_kdtree&#39;, &#39;np&#39;, &#39;p_o_p&#39;, &#39;pnt_&#39;, &#39;pnt_in_list&#39;, &#39;pnt_on_poly&#39;,</span>
<span class="sd">    &#39;pnt_on_seg&#39;, &#39;point_in_polygon&#39;, &#39;radial_sort&#39;,</span>
<span class="sd">    &#39;remove_self&#39;, &#39;rotate&#39;, &#39;seg_lengths&#39;, &#39;segment&#39;, &#39;simplify&#39;, &#39;stride&#39;,</span>
<span class="sd">    &#39;total_length&#39;, &#39;trans_rot&#39;</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">See ein_geom.py for full details and examples</span>

<span class="sd">`&lt;https://www.redblobgames.com/grids/hexagons/&gt;`_</span>

<span class="sd">`&lt;https://en.wikipedia.org/wiki/Centroid#Centroid_of_polygon&gt;`_</span>

<span class="sd">`&lt;https://iliauk.com/2016/03/02/centroids-and-centres-numpy-r/&gt;`_</span>

<span class="sd">*includes KDTree as well*</span>

<span class="sd">`&lt;https://stackoverflow.com/questions/50751135/iterating-operation-with-two-</span>
<span class="sd">arrays-using-numpy&gt;`_</span>

<span class="sd">`&lt;https://stackoverflow.com/questions/21483999/using-atan2-to-find-angle-</span>
<span class="sd">between-two-vectors&gt;`_</span>

<span class="sd">point in/on segment</span>

<span class="sd">`&lt;https://stackoverflow.com/questions/328107/how-can-you-determine-a-point</span>
<span class="sd">-is-between-two-other-points-on-a-line-segment&gt;`_.</span>

<span class="sd">benchmarking KDTree</span>

<span class="sd">`&lt;https://www.ibm.com/developerworks/community/blogs/jfp/entry/</span>
<span class="sd">Python_Is_Not_C_Take_Two?lang=en&gt;`_.</span>

<span class="sd">`&lt;https://iliauk.wordpress.com/2016/02/16/millions-of-distances-high-</span>
<span class="sd">performance-python/&gt;`_.</span>

<span class="sd">**cKDTree examples**</span>

<span class="sd">query_ball_point::</span>

<span class="sd">    x, y = np.mgrid[0:3, 0:3]</span>
<span class="sd">    pnts = np.c_[x.ravel(), y.ravel()]</span>
<span class="sd">    t = cKDTree(pnts)</span>
<span class="sd">    idx = t.query_ball_point([1, 0], 1)  # find points within x,y = (1,0)</span>
<span class="sd">    pnts[idx]</span>
<span class="sd">    array([[0, 0],</span>
<span class="sd">    ...    [1, 0],</span>
<span class="sd">    ...    [1, 1],</span>
<span class="sd">    ...    [2, 0]])</span>

<span class="sd">------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=C0103  # invalid-name</span>
<span class="c1"># pylint: disable=R0914  # Too many local variables</span>
<span class="c1"># pylint: disable=R1710  # inconsistent-return-statements</span>
<span class="c1"># pylint: disable=W0105  # string statement has no effect</span>

<span class="c1"># ---- imports, formats, constants ----</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="k">import</span> <span class="n">dedent</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.lib.stride_tricks</span> <span class="k">import</span> <span class="n">as_strided</span>
<span class="kn">from</span> <span class="nn">arraytools._basic</span> <span class="k">import</span> <span class="n">cartesian</span>

<span class="n">EPSILON</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span>  <span class="c1"># note! for checking</span>

<span class="n">ft</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span>
      <span class="s1">&#39;float_kind&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{: 0.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">}</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">edgeitems</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">nanstr</span><span class="o">=</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="n">infstr</span><span class="o">=</span><span class="s1">&#39;inf&#39;</span><span class="p">,</span>
                    <span class="n">threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">ft</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_print_option</span><span class="o">.</span><span class="n">set_display</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>  <span class="c1"># change to a single -</span>

<span class="n">script</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># print this should you need to locate the script</span>

<span class="c1"># ---- order by appearance ----</span>
<span class="c1">#</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_flat_&#39;</span><span class="p">,</span> <span class="s1">&#39;_unpack&#39;</span><span class="p">,</span>               <span class="c1"># general</span>
           <span class="s1">&#39;poly2segments&#39;</span><span class="p">,</span> <span class="s1">&#39;stride&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_new_view_&#39;</span><span class="p">,</span> <span class="s1">&#39;_view_&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_reshape_&#39;</span><span class="p">,</span>
           <span class="s1">&#39;min_&#39;</span><span class="p">,</span> <span class="s1">&#39;max_&#39;</span><span class="p">,</span>
           <span class="s1">&#39;extent_&#39;</span><span class="p">,</span>                         <span class="c1"># extent, centrality</span>
           <span class="s1">&#39;center_&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid_&#39;</span><span class="p">,</span>
           <span class="s1">&#39;centers&#39;</span><span class="p">,</span> <span class="s1">&#39;centroids&#39;</span><span class="p">,</span>
           <span class="s1">&#39;intersect_pnt&#39;</span><span class="p">,</span> <span class="s1">&#39;intersects&#39;</span><span class="p">,</span>     <span class="c1"># intersection</span>
           <span class="s1">&#39;e_area&#39;</span><span class="p">,</span> <span class="s1">&#39;e_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;e_leng&#39;</span><span class="p">,</span>      <span class="c1"># areas, distances, lengths</span>
           <span class="s1">&#39;e_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;cartesian_dist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;areas&#39;</span><span class="p">,</span> <span class="s1">&#39;lengths&#39;</span><span class="p">,</span>
           <span class="s1">&#39;total_length&#39;</span><span class="p">,</span> <span class="s1">&#39;seg_lengths&#39;</span><span class="p">,</span>
           <span class="s1">&#39;radial_sort&#39;</span><span class="p">,</span>                     <span class="c1"># sorting</span>
           <span class="s1">&#39;dist_bearing_sort&#39;</span><span class="p">,</span>
           <span class="s1">&#39;dx_dy_np&#39;</span><span class="p">,</span> <span class="s1">&#39;angle_between&#39;</span><span class="p">,</span>       <span class="c1"># angles, direction</span>
           <span class="s1">&#39;angle_np&#39;</span><span class="p">,</span> <span class="s1">&#39;azim_np&#39;</span><span class="p">,</span>
           <span class="s1">&#39;angle_2pnts&#39;</span><span class="p">,</span> <span class="s1">&#39;angle_seq&#39;</span><span class="p">,</span>
           <span class="s1">&#39;angles_poly&#39;</span><span class="p">,</span>
           <span class="s1">&#39;line_dir&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_densify_2D&#39;</span><span class="p">,</span> <span class="s1">&#39;_convert&#39;</span><span class="p">,</span>         <span class="c1"># densify simplify</span>
           <span class="s1">&#39;densify&#39;</span><span class="p">,</span> <span class="s1">&#39;simplify&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_rot&#39;</span><span class="p">,</span>             <span class="c1"># translation, rotation</span>
           <span class="s1">&#39;pnt_in_list&#39;</span><span class="p">,</span>                     <span class="c1"># spatial queries and analysis</span>
           <span class="s1">&#39;pnt_on_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;pnt_on_poly&#39;</span><span class="p">,</span>
           <span class="s1">&#39;point_in_polygon&#39;</span><span class="p">,</span>
           <span class="s1">&#39;knn&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_kdtree&#39;</span><span class="p">,</span> <span class="s1">&#39;cross&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_self&#39;</span><span class="p">,</span>
           <span class="s1">&#39;adjacency_edge&#39;</span>
           <span class="p">]</span>


<span class="c1"># ---- array functions -------------------------------------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_flat_</span><span class="p">(</span><span class="n">a_list</span><span class="p">,</span> <span class="n">flat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the isinstance as appropriate.  Flatten an object using recursion</span>

<span class="sd">    see: itertools.chain() for an alternate method of flattening.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">void</span><span class="p">)):</span>
            <span class="n">_flat_</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">flat_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flat_list</span>


<span class="k">def</span> <span class="nf">_unpack</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unpack an iterable based on the param(eter) condition using recursion.</span>
<span class="sd">    From `unpack` in `_common.py`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
            <span class="n">xy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xy</span>


<div class="viewcode-block" id="poly2segments"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.poly2segments">[docs]</a><span class="k">def</span> <span class="nf">poly2segments</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Segment poly* structures into o-d pairs from start to finish</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        A 2D array of x,y coordinates representing polyline or polygons.</span>
<span class="sd">    fr_to : array</span>
<span class="sd">        Returns a 3D array of point pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>     <span class="c1"># squeeze (1, n, m), (n, 1, m) (n, m, 1) arrays</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fr_to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">fr_to</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fr_to</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">fr_to</span></div>


<div class="viewcode-block" id="stride"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.stride">[docs]</a><span class="k">def</span> <span class="nf">stride</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stepby</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Provide a 2D sliding/moving view of an array.</span>
<span class="sd">    There is no edge correction for outputs. Use the `_pad_` function first.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">        Origin arraytools.tools  stride, see it for more information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Array shape, window and/or step size error.</span>
<span class="s2">    Use win=(3,) with stepby=(1,) for 1D array</span>
<span class="s2">    or win=(3,3) with stepby=(1,1) for 2D array</span>
<span class="s2">    or win=(1,3,3) with stepby=(1,1,1) for 3D</span>
<span class="s2">    ----    a.ndim != len(win) != len(stepby) ----</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">win</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">win</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">stepby</span><span class="p">)),</span> <span class="n">err</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># array shape (r, c) or (d, r, c)</span>
    <span class="n">win_shp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>    <span class="c1"># window      (3, 3) or (1, 3, 3)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stepby</span><span class="p">)</span>      <span class="c1"># step by     (1, 1) or (1, 1, 1)</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(((</span><span class="n">shape</span> <span class="o">-</span> <span class="n">win_shp</span><span class="p">)</span> <span class="o">//</span> <span class="n">ss</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">win_shp</span><span class="p">)</span>
    <span class="n">newstrides</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">)</span> <span class="o">*</span> <span class="n">ss</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">strides</span>
    <span class="n">a_s</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">newshape</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">newstrides</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">a_s</span></div>


<span class="c1"># ---- _view and _reshape_ are helper functions -----------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View a structured array x,y coordinates as an ndarray to facilitate</span>
<span class="sd">    some array calculations.</span>

<span class="sd">    NOTE,  see _view_ for the same functionality</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_view_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a view of the array using the dtype and length</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The is a quick function.  The expectation is that they are coordinate</span>
<span class="sd">    values in the form  dtype([(&#39;X&#39;, &#39;&lt;f8&#39;), (&#39;Y&#39;, &#39;&lt;f8&#39;)])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reshape arrays, structured or recarrays of coordinates to a 2D ndarray.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The length of the dtype is checked. Only object (&#39;O&#39;) and arrays with</span>
<span class="sd">#    a uniform dtype return 0.  Structured, recarrays will yield 1 or more.</span>
<span class="sd">#    Array dtypes are stripped and the array reshaped.</span>
<span class="sd">#</span>
<span class="sd">#    &gt;&gt;&gt; a = np.array([(341000., 5021000.), (341000., 5022000.),</span>
<span class="sd">#    ...               (342000., 5022000.), (341000., 5021000.)],</span>
<span class="sd">#    ...              dtype=[(&#39;X&#39;, &#39;&lt;f8&#39;), (&#39;Y&#39;, &#39;&lt;f8&#39;)])</span>
<span class="sd">#</span>
<span class="sd">#    becomes:</span>
<span class="sd">#</span>
<span class="sd">#    &gt;&gt;&gt; a = np.array([[  341000.,  5021000.], [  341000.,  5022000.],</span>
<span class="sd">#                      [  342000.,  5022000.], [  341000.,  5021000.]])</span>
<span class="sd">#    &gt;&gt;&gt; a.dtype = dtype(&#39;float64&#39;)</span>
<span class="sd">#</span>
<span class="sd">#    3D arrays are collapsed to 2D</span>
<span class="sd">#</span>
<span class="sd">#    &gt;&gt;&gt; a.shape = (2, 5, 2) =&gt; np.product(a.shape[:-1], 2) =&gt; (10, 2)</span>

<span class="sd">    Object arrays are processed object by object but assumed to be of a</span>
<span class="sd">    common dtype within, as would be expected from a gis package.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An array is required...&quot;</span><span class="p">)</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">_view_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shp</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">shp</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmp</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fld_name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assumes &#39;Shape&#39; field is the geometry</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="n">fld_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">_len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="n">_view_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">view</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="n">_view_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="c1"># ---- extent, mins and maxs ------------------------------------------------</span>
<span class="c1"># Note:</span>
<span class="c1">#     The functions here use _reshape_ to ensure compatability with structured</span>
<span class="c1">#  or recarrays.  ndarrays pass through _reshape_ untouched.</span>
<span class="c1">#  _view_ or _new_view_ could also be used but are only suited for x,y</span>
<span class="c1">#  structured/recarrays</span>
<span class="c1">#</span>
<div class="viewcode-block" id="min_"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.min_">[docs]</a><span class="k">def</span> <span class="nf">min_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Array minimums</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mins</span></div>


<div class="viewcode-block" id="max_"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.max_">[docs]</a><span class="k">def</span> <span class="nf">max_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Array maximums</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxs</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxs</span></div>


<div class="viewcode-block" id="extent_"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.extent_">[docs]</a><span class="k">def</span> <span class="nf">extent_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Array extent values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">min_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">maxs</span> <span class="o">=</span> <span class="n">max_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">min_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">max_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<span class="c1"># ---- centers --------------------------------------------------------------</span>
<div class="viewcode-block" id="center_"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.center_">[docs]</a><span class="k">def</span> <span class="nf">center_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">remove_dup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the center of an array. If the array represents a polygon, then</span>
<span class="sd">    a check is made for the duplicate first and last point to remove one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_dup</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="centroid_"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.centroid_">[docs]</a><span class="k">def</span> <span class="nf">centroid_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_6</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the centroid of a closed polygon.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        A 2D or more of point coordinates.  You need to keep the duplicate</span>
<span class="sd">        first and last point.</span>
<span class="sd">    a_6 : number</span>
<span class="sd">        If area has been precalculated, you can use its value.</span>
<span class="sd">    e_area : function (required)</span>
<span class="sd">        Contained in this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">if</span> <span class="n">a_6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a_6</span> <span class="o">=</span> <span class="n">e_area</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="mf">6.0</span>  <span class="c1"># area * 6.0</span>
    <span class="n">x_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_6</span>
    <span class="n">y_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_6</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="n">x_c</span><span class="p">,</span> <span class="o">-</span><span class="n">y_c</span><span class="p">])</span></div>


<div class="viewcode-block" id="centers"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.centers">[docs]</a><span class="k">def</span> <span class="nf">centers</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">remove_dup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;batch centres (ie _center)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_reshape_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">center_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">remove_dup</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">center_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">remove_dup</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="centroids"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.centroids">[docs]</a><span class="k">def</span> <span class="nf">centroids</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;batch centroids (ie _centroid)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_reshape_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">centroid_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">centroid_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span></div>


<span class="c1"># ---- point functions ------------------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="intersect_pnt"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.intersect_pnt">[docs]</a><span class="k">def</span> <span class="nf">intersect_pnt</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the point of intersection of the vectors passing through two</span>
<span class="sd">    point pairs (p0, p1) and (p2, p3).  This is not segment-segment</span>
<span class="sd">    intersection.  An extrapolation will be returned if the segments do not</span>
<span class="sd">    cross and the point of intersection will be returned where they **would**</span>
<span class="sd">    intersect.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array-like</span>
<span class="sd">        1 segment  [p0, p1]</span>
<span class="sd">        2 segments [p0, p1], [p2, p3] or</span>
<span class="sd">        1 array-like np.array([p0, p1, p2, p3])</span>
<span class="sd">    b : None or array-like</span>
<span class="sd">        1 segment [p2, p3]  if `a` is [p0, p1], or ``None``</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; s = np.array([[ 0,  0], [10, 10], [ 0,  5], [ 5,  0]])</span>
<span class="sd">     s: array([[ 0,  0],    h: array([[  0.,   0.,   1.],</span>
<span class="sd">               [10, 10],              [ 10.,  10.,   1.],</span>
<span class="sd">               [ 0,  5],              [  0.,   5.,   1.],</span>
<span class="sd">               [ 5,  0]])             [  5.,   0.,   1.]])</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `&lt;https://stackoverflow.com/questions/3252194/numpy-and-line-</span>
<span class="sd">    intersections&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Use a 4 point array or 2, 2-pnt lines&quot;</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>  <span class="c1"># h for homogeneous</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>            <span class="c1"># get first line</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>            <span class="c1"># get second line</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>           <span class="c1"># point of intersection</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                           <span class="c1"># lines are parallel</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="p">)</span></div>


<div class="viewcode-block" id="intersects"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.intersects">[docs]</a><span class="k">def</span> <span class="nf">intersects</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Line intersection check.  Two lines or 4 points that form the lines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    - intersects(line0, line1)</span>
<span class="sd">    - intersects(p0, p1, p2, p3)</span>

<span class="sd">      - p0, p1 -&gt; line 0</span>
<span class="sd">      - p2, p3 -&gt; line 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean, if the segments do intersect</span>

<span class="sd">    &gt;&gt;&gt; a = np.array([[0, 0], [10, 10]])</span>
<span class="sd">    &gt;&gt;&gt; b = np.array([[0, 10], [10, 0]])</span>
<span class="sd">    &gt;&gt;&gt; intersects(*args)  # True</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ::</span>

<span class="sd">        c = np.array([[0, 0], [0, 90], [90, 90], [60, 60], [20, 20], [0, 0]])</span>
<span class="sd">        segs = [np.array([c[i-1], c[i]]) for i in range(1, len(c))]</span>
<span class="sd">        ln = np.array([[50, -10], [50, 100]])</span>
<span class="sd">        print(&quot;line {}&quot;.format(ln.ravel()))</span>
<span class="sd">        for i, j in enumerate(segs):</span>
<span class="sd">            r = intersects(ln, j)</span>
<span class="sd">            print(&quot;{}..{}&quot;.format(j.ravel(), r))</span>
<span class="sd">        ...</span>
<span class="sd">        line [ 50 -10  50 100]</span>
<span class="sd">        [ 0  0  0 90]..(False, &#39;collinear&#39;)</span>
<span class="sd">        [ 0 90 90 90]..(True, (50.0, 90.0))</span>
<span class="sd">        [90 90 60 60]..(False, &#39;denom check&#39;)</span>
<span class="sd">        [60 60 20 20]..(True, (50.0, 50))</span>
<span class="sd">        [20 20  0  0]..(False, &#39;cross(p1-p0, p0-p2)&#39;)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `&lt;https://stackoverflow.com/questions/563198/how-do-you-detect-where-two-</span>
<span class="sd">    line-segments-intersect#565282&gt;`_.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>    <span class="c1"># two lines</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># four points</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Pass 2, 2-pnt lines or 4 points to the function&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="o">*</span><span class="n">p0</span><span class="p">,</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="o">*</span><span class="n">p3</span>  <span class="c1"># points to xs and ys</span>
    <span class="c1">#</span>
    <span class="c1"># ---- First check ----   np.cross(p1-p0, p3-p2 )</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">denom</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># collinear</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;collinear&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># ---- Second check ----  np.cross(p1-p0, p0-p2)</span>
    <span class="n">denom_gt0</span> <span class="o">=</span> <span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># denominator greater than zero</span>
    <span class="c1">#</span>
    <span class="n">s_numer</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s_numer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">denom_gt0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;cross(p1-p0, p0-p2)&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># ---- Third check ----  np.cross(p3-p2, p0-p2)</span>
    <span class="n">t_numer</span> <span class="o">=</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t_numer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">denom_gt0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;cross(p3-p2, p0-p2)&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># ---- Fourth check ----</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">s_numer</span> <span class="o">&gt;</span> <span class="n">denom</span><span class="p">)</span> <span class="o">==</span> <span class="n">denom_gt0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">t_numer</span> <span class="o">&gt;</span> <span class="n">denom</span><span class="p">)</span> <span class="o">==</span> <span class="n">denom_gt0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;denom check&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># ---- check to see if the intersection point is one of the input points</span>
    <span class="c1"># substitute p0 in the equation  These are the intersection points</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t_numer</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>
    <span class="c1"># be careful that you are comparing tuples to tuples, lists to lists</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;not input point&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>


<span class="c1"># ---- distance, length and area --------------------------------------------</span>
<span class="c1"># ----</span>
<div class="viewcode-block" id="e_area"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.e_area">[docs]</a><span class="k">def</span> <span class="nf">e_area</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Area calculation, using einsum.</span>

<span class="sd">    Some may consider this overkill, but consider a huge list of polygons,</span>
<span class="sd">    many multipart, many with holes and even multiple version therein.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    preprocessing :</span>
<span class="sd">        use `_view_`, `_new_view_` or `_reshape_` with structured/recarrays</span>
<span class="sd">    a : array</span>
<span class="sd">        Either a 2D+ array of coordinates or arrays of x, y values</span>
<span class="sd">    b : array, optional</span>
<span class="sd">        If a &lt; 2D, then the y values need to be supplied</span>
<span class="sd">    Outer rings are ordered clockwise, inner holes are counter-clockwise</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    See ein_geom.py for examples</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">e0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;...ij,...ij-&gt;...i&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;...ij,...ij-&gt;...i&#39;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">e0</span> <span class="o">-</span> <span class="n">e1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">area</span></div>


<div class="viewcode-block" id="e_dist"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.e_dist">[docs]</a><span class="k">def</span> <span class="nf">e_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Distance calculation for 1D, 2D and 3D points using einsum</span>

<span class="sd">    preprocessing :</span>
<span class="sd">        use `_view_`, `_new_view_` or `_reshape_` with structured/recarrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b : array like</span>
<span class="sd">        Inputs, list, tuple, array in 1, 2 or 3D form</span>
<span class="sd">    metric : string</span>
<span class="sd">        euclidean (&#39;e&#39;, &#39;eu&#39;...), sqeuclidean (&#39;s&#39;, &#39;sq&#39;...),</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    mini e_dist for 2d points array and a single point</span>

<span class="sd">    &gt;&gt;&gt; def e_2d(a, p):</span>
<span class="sd">            diff = a - p[np.newaxis, :]  # a and p are ndarrays</span>
<span class="sd">            return np.sqrt(np.einsum(&#39;ij,ij-&gt;i&#39;, diff, diff))</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cartesian_dist : function</span>
<span class="sd">        Produces pairs of x,y coordinates and the distance, without duplicates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">a_dim</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">b_dim</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">a_dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">a_dim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">b_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
    <span class="n">dist_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,ijk-&gt;ij&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
        <span class="n">dist_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_arr</span><span class="p">)</span>
    <span class="n">dist_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dist_arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist_arr</span></div>


<div class="viewcode-block" id="e_leng"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.e_leng">[docs]</a><span class="k">def</span> <span class="nf">e_leng</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Length/distance between points in an array using einsum</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    preprocessing :</span>
<span class="sd">        use `_view_`, `_new_view_` or `_reshape_` with structured/recarrays</span>
<span class="sd">    a : array-like</span>
<span class="sd">        A list/array coordinate pairs, with ndim = 3 and the minimum</span>
<span class="sd">        shape = (1,2,2), eg. (1,4,2) for a single line of 4 pairs</span>

<span class="sd">    The minimum input needed is a pair, a sequence of pairs can be used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    length : float</span>
<span class="sd">        The total length/distance formed by the points</span>
<span class="sd">    d_leng : float</span>
<span class="sd">        The distances between points forming the array</span>

<span class="sd">        (40.0, [array([[ 10.,  10.,  10.,  10.]])])</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; diff = g[:, :, 0:-1] - g[:, :, 1:]</span>
<span class="sd">    &gt;&gt;&gt; # for 4D</span>
<span class="sd">    &gt;&gt;&gt; d = np.einsum(&#39;ijk..., ijk...-&gt;ijk...&#39;, diff, diff).flatten()  # or</span>
<span class="sd">    &gt;&gt;&gt; d  = np.einsum(&#39;ijkl, ijkl-&gt;ijk&#39;, diff, diff).flatten()</span>
<span class="sd">    &gt;&gt;&gt; d = np.sum(np.sqrt(d)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
<span class="c1">#    d_leng = 0.0</span>
    <span class="c1"># ----</span>
    <span class="k">def</span> <span class="nf">_cal</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; perform the calculation, see above</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d_leng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,ijk-&gt;ij&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_leng</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">length</span><span class="p">,</span> <span class="n">d_leng</span>
    <span class="c1"># ----</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">length</span><span class="p">,</span> <span class="n">d_leng</span> <span class="o">=</span> <span class="n">_cal</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_leng</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">leng</span><span class="p">,</span> <span class="n">d_leng</span> <span class="o">=</span> <span class="n">_cal</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_leng</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">+=</span> <span class="n">leng</span>
    <span class="k">return</span> <span class="n">length</span><span class="p">,</span> <span class="n">diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="cartesian_dist"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.cartesian_dist">[docs]</a><span class="k">def</span> <span class="nf">cartesian_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form the cartesian product of two 2D arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b : arrays</span>
<span class="sd">        2D array of x,y values</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The `cartesian` function defined within.  The arrays are passed to it to</span>
<span class="sd">    format the data structure to from-to x,y coordinate pairs.</span>

<span class="sd">    The cartesian_dist function is about 2X slower than e_dist from</span>
<span class="sd">    arraytools.geom.  It depends on whether you need the x,y coordinate pairs</span>
<span class="sd">    and the distance or just one of the two forms of the distance matrix.</span>

<span class="sd">    &gt;&gt;&gt; a, b</span>
<span class="sd">    array([[0., 0.],   array([[3., 3.],</span>
<span class="sd">           [1., 1.],          [4., 4.]])</span>
<span class="sd">           [2., 2.]])</span>
<span class="sd">    cartesian_dist(a,b)</span>
<span class="sd">    array([[0.  , 0.  , 3.  , 3.  , 4.24],</span>
<span class="sd">           [0.  , 0.  , 4.  , 4.  , 5.66],</span>
<span class="sd">           [1.  , 1.  , 3.  , 3.  , 2.83],</span>
<span class="sd">           [1.  , 1.  , 4.  , 4.  , 4.24],</span>
<span class="sd">           [2.  , 2.  , 3.  , 3.  , 1.41],</span>
<span class="sd">           [2.  , 2.  , 4.  , 4.  , 2.83]])</span>
<span class="sd">    &gt;&gt;&gt; d = e_dist(a, b)</span>
<span class="sd">    array([[4.24, 5.66],   # a0-&gt;b0, a0-&gt;b1</span>
<span class="sd">           [2.83, 4.24],   # a1-&gt;b0, a1-&gt;b1</span>
<span class="sd">           [1.41, 2.83]])  # a2-&gt;b0, a2-&gt;b1</span>
<span class="sd">    &gt;&gt;&gt; d.ravel()  # array([4.24, 5.66, 2.83, 4.24, 1.41, 2.83])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cartesian</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># ---- Batch calculations of e_area and e_leng ------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="areas"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.areas">[docs]</a><span class="k">def</span> <span class="nf">areas</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls e_area to calculate areas for many types of nested objects.</span>

<span class="sd">    This would include object arrays, list of lists and similar constructs.</span>
<span class="sd">    Each part is considered separately.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A list with one or more areas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_reshape_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e_area</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">a_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_area</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a_s</span></div>


<div class="viewcode-block" id="lengths"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.lengths">[docs]</a><span class="k">def</span> <span class="nf">lengths</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">prn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls `e_leng` to calculate lengths for many types of nested objects.</span>
<span class="sd">    This would include object arrays, list of lists and similar constructs.</span>
<span class="sd">    Each part is considered separately.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A list with one or more lengths. `prn=True` for optional printing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_prn_</span><span class="p">(</span><span class="n">a_s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;optional result printing&quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{!s:&lt;12}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Tot. Length&quot;</span><span class="p">,</span> <span class="s2">&quot;Seg. Length&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:12.3f}</span><span class="s2">  </span><span class="si">{!r:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">a_s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_s</span><span class="p">))]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_reshape_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="n">a_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_leng</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prn</span><span class="p">:</span>
            <span class="n">_prn_</span><span class="p">(</span><span class="n">a_s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a_s</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_reshape_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e_leng</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">a_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_leng</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prn</span><span class="p">:</span>
        <span class="n">_prn_</span><span class="p">(</span><span class="n">a_s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a_s</span></div>


<div class="viewcode-block" id="total_length"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.total_length">[docs]</a><span class="k">def</span> <span class="nf">total_length</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just return total length from &#39;length&#39; above</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        List of array(s) containing the total length for each object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_s</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a_s</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="seg_lengths"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.seg_lengths">[docs]</a><span class="k">def</span> <span class="nf">seg_lengths</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just return segment lengths from &#39;length above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        List of array(s) containing the segment lengths for each object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_s</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a_s</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1"># ---- sorting based on geometry --------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="radial_sort"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.radial_sort">[docs]</a><span class="k">def</span> <span class="nf">radial_sort</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_azimuth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort about the point cloud center or from a given point</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pnts : points</span>
<span class="sd">        An array of points (x,y) as array or list</span>
<span class="sd">    cent : array-like</span>
<span class="sd">        - A list, tuple, array of the center&#39;s x,y coordinates.</span>
<span class="sd">        - None, the center&#39;s coordinate is calculated from the values with</span>
<span class="sd">          duplicates removed</span>

<span class="sd">    &gt;&gt;&gt; cent = [0, 0] or np.array([0, 0])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    - The angles in the range -180, 180 x-axis oriented</span>
<span class="sd">    - The pnts are NOT returned sorted, you will have to use the sort_order to</span>
<span class="sd">      complete the sorting.</span>

<span class="sd">    &gt;&gt;&gt; pnts_sorted = pnts[sort_order]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pnts</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">pnts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">center_</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">remove_dup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">pnts</span> <span class="o">-</span> <span class="n">cent</span>
    <span class="n">ang_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ba</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ang_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ang_ab</span><span class="p">)</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ang_ab</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">as_azimuth</span><span class="p">:</span>
        <span class="n">ang_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ang_ab</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">,</span> <span class="mf">450.0</span> <span class="o">-</span> <span class="n">ang_ab</span><span class="p">,</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">ang_ab</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">e_dist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ba</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ang_ab</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">,</span> <span class="n">dist</span>
    <span class="k">return</span> <span class="n">ang_ab</span><span class="p">,</span> <span class="n">sort_order</span></div>


<span class="c1"># ---- angle related functions ----------------------------------------------</span>
<span class="c1"># ---- ndarrays and structured arrays ----</span>
<span class="c1">#</span>
<div class="viewcode-block" id="dist_bearing_sort"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.dist_bearing_sort">[docs]</a><span class="k">def</span> <span class="nf">dist_bearing_sort</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_struct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sorts points based on a radial sort of a point set (X, Y) relative to</span>
<span class="sd">    the center of the points.  The sort is done using the bearing, then the</span>
<span class="sd">    distance of a point to the center.</span>

<span class="sd">    *** Note done *** move to arraytools.wars when complete</span>

<span class="sd">    xy = a0[0][[&#39;X&#39;, &#39;Y&#39;]]</span>
<span class="sd">    pnts = _view_(xy) or....</span>
<span class="sd">    s = dist_bearing_sort(a0[0][[&#39;X&#39;, &#39;Y&#39;]])</span>
<span class="sd">    s.shape # (69688, 2)</span>
<span class="sd">    11.4 ms ± 272 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_xy_struct_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;construct a structured array from x,y data in an N-2 array assuming</span>
<span class="sd">        X is first column and Y follows</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">z</span>
    <span class="c1">#</span>
    <span class="n">ang</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">radial_sort</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">cent</span><span class="o">=</span><span class="n">cent</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">pnts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pnts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ang</span><span class="p">,</span> <span class="n">dist</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mf">180.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>  <span class="c1"># on distance</span>
    <span class="n">cnts</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">hist</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">low</span><span class="p">)):</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="n">d_max</span> <span class="o">=</span> <span class="n">s0</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">d_max</span><span class="o">*</span><span class="mf">0.1</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">s0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s0</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">d_max</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="n">s0</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">d_max</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">s0</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">out</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">as_struct</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_xy_struct_</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">cnts</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">out</span></div>


<div class="viewcode-block" id="dx_dy_np"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.dx_dy_np">[docs]</a><span class="k">def</span> <span class="nf">dx_dy_np</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequential difference in the x/y pairs from a table/array</span>

<span class="sd">    a : ndarray or structured array.</span>
<span class="sd">        It is changed as necessary to a 2D array of x/y values.</span>
<span class="sd">    _new_view_ : function</span>
<span class="sd">        Does the array conversion to 2D from structured if necessary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">diff</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="angle_np"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.angle_np">[docs]</a><span class="k">def</span> <span class="nf">angle_np</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">as_degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Angle between successive points.</span>

<span class="sd">    Requires, `dx_dy_np` and hence, `_new_view_`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">dx_dy_np</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">diff</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">diff</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">as_degrees</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="azim_np"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.azim_np">[docs]</a><span class="k">def</span> <span class="nf">azim_np</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the azimuth/bearing relative to North</span>

<span class="sd">    Requires, `angle_np`, which calls `dx_dy_np` which calls `_new_view_`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">angle_np</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">as_degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">azim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">s</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">450.0</span> <span class="o">-</span> <span class="n">s</span><span class="p">,</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">azim</span></div>


<div class="viewcode-block" id="angle_between"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.angle_between">[docs]</a><span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;angle between 3 sequential points</span>

<span class="sd">    &gt;&gt;&gt; p0, p1, p2 = np.array([[0, 0],[1, 1], [1, 0]])</span>
<span class="sd">    angle_between(p0, p1, p2)</span>
<span class="sd">    (45.0, -135.0, -90.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">ang1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">d1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ang2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">d2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">ang2</span> <span class="o">-</span> <span class="n">ang1</span><span class="p">)</span>  <span class="c1"># % (2 * np.pi)</span>
    <span class="n">ang</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ang</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">ang</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span></div>


<span class="c1"># ---- ndarrays</span>
<div class="viewcode-block" id="angle_2pnts"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.angle_2pnts">[docs]</a><span class="k">def</span> <span class="nf">angle_2pnts</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two point angle. p0 represents the `from` point and p1 the `to` point.</span>

<span class="sd">    &gt;&gt;&gt; angle = atan2(vector2.y, vector2.x) - atan2(vector1.y, vector1.x)</span>

<span class="sd">    Accepted answer from the poly_angles link</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">]]</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">ang_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">ba</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ang_ab</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span></div>


<div class="viewcode-block" id="angle_seq"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.angle_seq">[docs]</a><span class="k">def</span> <span class="nf">angle_seq</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequential angles for a points list</span>

<span class="sd">    &gt;&gt;&gt; angle = atan2(vector2.y, vector2.x) - atan2(vector1.y, vector1.x)</span>
<span class="sd">    Accepted answer from the poly_angles link</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ang_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ba</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ang_ab</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span></div>


<div class="viewcode-block" id="angles_poly"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.angles_poly">[docs]</a><span class="k">def</span> <span class="nf">angles_poly</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">in_deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequential 3 point angles from a poly* shape</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        an array of points, derived from a polygon/polyline geometry</span>
<span class="sd">    inside : boolean</span>
<span class="sd">        determine inside angles, outside if False</span>
<span class="sd">    in_deg : bolean</span>
<span class="sd">        convert to degrees from radians</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    General comments::</span>

<span class="sd">        2 points - subtract 2nd and 1st points, effectively making the</span>
<span class="sd">        calculation relative to the origin and x axis, aka... slope</span>
<span class="sd">        n points - sequential angle between 3 points</span>

<span class="sd">    To keep::</span>

<span class="sd">        ``keep to convert object to array``</span>
<span class="sd">        a - a shape from the shape field</span>
<span class="sd">        a = p1.getPart()</span>
<span class="sd">        b = np.asarray([(i.X, i.Y) if i is not None else ()</span>
<span class="sd">                       for j in a for i in j])</span>

<span class="sd">    Sample data: the letter C</span>

<span class="sd">    &gt;&gt;&gt; a = np.array([[ 0, 0], [ 0, 100], [100, 100], [100,  80],</span>
<span class="sd">                      [ 20,  80], [ 20, 20], [100, 20], [100, 0], [ 0, 0]])</span>
<span class="sd">    &gt;&gt;&gt; angles_poly(a)  # array([ 90.,  90.,  90., 270., 270.,  90.,  90.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">ba</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">-</span> <span class="n">a0</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">ba</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">two_pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.</span>
    <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ang</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ang</span> <span class="o">+</span> <span class="n">two_pi</span><span class="p">,</span> <span class="n">ang</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ang</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">two_pi</span> <span class="o">-</span> <span class="n">ang</span><span class="p">,</span> <span class="n">ang</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">in_deg</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angles</span></div>


<div class="viewcode-block" id="line_dir"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.line_dir">[docs]</a><span class="k">def</span> <span class="nf">line_dir</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">fromNorth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Direction of a line given 2 points</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orig, dest : arrays</span>
<span class="sd">        2D arrays of representing the start and end coordinates of two point</span>
<span class="sd">        lines.</span>
<span class="sd">    fromNorth : boolean</span>
<span class="sd">        True or False gives angle relative to North or the x-axis.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; orig = np.array([0, 0])</span>
<span class="sd">    &gt;&gt;&gt; xy_s = array([[-1,  0,  1,  1,  1,  0, -1, -1],</span>
<span class="sd">                      [ 1,  1,  1,  0, -1, -1, -1,  0]])</span>
<span class="sd">    &gt;&gt;&gt; dest - xy_s.T</span>
<span class="sd">    &gt;&gt;&gt; dir_ = [&quot;From x-axis&quot;, &quot;From N.&quot;][fromNorth]</span>
<span class="sd">    &gt;&gt;&gt; ang = line_dir(orig, dest, fromNorth=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">-</span> <span class="n">orig</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dxy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dxy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">fromNorth</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="mf">450.0</span> <span class="o">-</span> <span class="n">ang</span><span class="p">),</span> <span class="mf">360.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ang</span></div>


<span class="c1"># ---- densify functions -----------------------------------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_densify_2D</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Densify a 2D array using np.interp.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        Input polyline or polygon array coordinates</span>
<span class="sd">    fact : number</span>
<span class="sd">        The factor to density the line segments by</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">        Original construction of c rather than the zero&#39;s approach.</span>
<span class="sd">    Example</span>
<span class="sd">    ::</span>
<span class="sd">          c0 = c0.reshape(n, -1)</span>
<span class="sd">          c1 = c1.reshape(n, -1)</span>
<span class="sd">          c = np.concatenate((c0, c1), 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Y = a changed all the y&#39;s to a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">n_fact</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fact</span><span class="p">,</span> <span class="n">fact</span><span class="p">)</span>
    <span class="n">b_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_fact</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Where you want to interpolate</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">b_new</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">b_new</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">c0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">c</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c0</span>
    <span class="n">c</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span>
    <span class="k">return</span> <span class="n">c</span>


<span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">check_arcpy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do the shape conversion for the array parts.  Calls _densify_2D</span>

<span class="sd">    # import arcpy  # uncomment the first line below if using _convert</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">check_arcpy</span><span class="p">:</span>
        <span class="c1">#import arcpy</span>
        <span class="kn">from</span> <span class="nn">arcpy.arcobjects</span> <span class="k">import</span> <span class="n">Point</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="n">sub_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="n">_densify_2D</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">)</span>  <span class="c1"># call _densify_2D</span>
            <span class="n">arc_pnts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">shp</span><span class="p">]</span>
            <span class="n">sub_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arc_pnts</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">shp</span> <span class="o">=</span> <span class="n">_densify_2D</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">)</span>
                <span class="n">arc_pnts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="n">ps</span><span class="p">)</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">shp</span><span class="p">]</span>
                <span class="n">sub_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arc_pnts</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<div class="viewcode-block" id="densify"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.densify">[docs]</a><span class="k">def</span> <span class="nf">densify</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert polygon objects to arrays, densify.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    `_densify_2D` : function</span>
<span class="sd">        the function that is called for each shape part</span>
<span class="sd">    `_unpack` : function</span>
<span class="sd">        unpack objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ---- main section ----</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">__geo_interface__</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fact</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># ---- simplify functions -----------------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="simplify"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.simplify">[docs]</a><span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">deviation</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simplify array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">angles_poly</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">in_deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angles</span> <span class="o">-</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">deviation</span><span class="p">)</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">angles</span></div>


<span class="c1"># ---- Create geometries -----------------------------------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">pnt_</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a point object for null points, center points etc</span>
<span class="sd">    ::</span>
<span class="sd">        pnt_((1., 2.)\n</span>
<span class="sd">        pnt_(1) =&gt; array([1., 1.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Numeric points supported, not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">p</span>


<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate points about the origin in degrees, (+ve for clockwise) &quot;&quot;&quot;</span>
    <span class="n">pnts</span> <span class="o">=</span> <span class="n">_new_view_</span><span class="p">(</span><span class="n">pnts</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>                 <span class="c1"># convert to radians</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>    <span class="c1"># rotation terms</span>
    <span class="n">aff_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>  <span class="c1"># rotation matrix</span>
    <span class="n">XY_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">aff_matrix</span><span class="p">)</span>           <span class="c1"># numpy magic to rotate pnts</span>
    <span class="k">return</span> <span class="n">XY_r</span></div>


<span class="k">def</span> <span class="nf">affine_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">clockwise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate and rotate an array of points about its center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    center : boolean</span>
<span class="sd">        True, the center point is used as the origin of the axis of rotation.</span>
<span class="sd">        False, no translation is used prior to rotation.</span>
<span class="sd">    angle : number</span>
<span class="sd">        The rotation angle, in degrees, to rotate the points.</span>
<span class="sd">    clockwise : boolean</span>
<span class="sd">        True, negates the angle for CW rotation.  False leaves the angle along.</span>

<span class="sd">    &gt;&gt;&gt; from arraytools.graphing.arr_scatter import plot_pnts_ as pl</span>
<span class="sd">    &gt;&gt;&gt; a = np.array([[0, 0], [0, 6], [8, 6], [8, 0], [4, 3]])</span>
<span class="sd">    &gt;&gt;&gt; a0 = affine_(a, center=True, angle=22.5, clockwise=False)</span>
<span class="sd">    &gt;&gt;&gt; pl([a, b], params=False)</span>

<span class="sd">    einsum notes::</span>

<span class="sd">        # ---- default, translate to origin, rotate CCW and translate back</span>
<span class="sd">        a0 = np.einsum(&#39;ij,jk-&gt;ik&#39;, a-cent, R)</span>
<span class="sd">        # ---- alternate if one wants a CW rotation immediately</span>
<span class="sd">        a1 = np.einsum(&#39;ij,nj-&gt;in&#39;, a-cent, R)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">clockwise</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">angle</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)))</span>
    <span class="k">return</span>  <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">-</span><span class="n">cent</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">cent</span>


<div class="viewcode-block" id="trans_rot"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.trans_rot">[docs]</a><span class="k">def</span> <span class="nf">trans_rot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate and rotate and array of points about the point cloud origin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        2d array of x,y coordinates.</span>
<span class="sd">    angle : double</span>
<span class="sd">        angle in degrees in the range -180. to 180</span>
<span class="sd">    unique : boolean</span>
<span class="sd">        If True, then duplicate points are removed.  If False, then this would</span>
<span class="sd">        be similar to doing a weighting on the points based on location.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Points rotated about the origin and translated back.</span>

<span class="sd">    &gt;&gt;&gt; a = np.array([[0, 0], [0, 6], [8, 6], [8, 0]])  #, [0, 0]])</span>
<span class="sd">    &gt;&gt;&gt; b = trans_rot(a, 2.5)</span>
<span class="sd">    &gt;&gt;&gt; b</span>
<span class="sd">    array([[ 0.5,  1.5],</span>
<span class="sd">           [ 1.5,  1.5],</span>
<span class="sd">           [ 0.5, -0.5],</span>
<span class="sd">           [ 1.5, -0.5]])</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - if the points represent a polygon, make sure that the duplicate</span>
<span class="sd">    - np.einsum(&#39;ij,kj-&gt;ik&#39;, a - cent, R)  =  np.dot(a - cent, R.T).T</span>
<span class="sd">    - ik does the rotation in einsum</span>

<span class="sd">    &gt;&gt;&gt; R = np.array(((c, s), (-s,  c)))  # clockwise about the origin</span>

<span class="sd">    *** use this ***</span>
<span class="sd">    `&lt;https://stackoverflow.com/questions/54445195/</span>
<span class="sd">    np-tensordot-for-rotation-of-point-clouds&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)))</span>
    <span class="k">return</span>  <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">cent</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">cent</span></div>


<span class="c1"># ---- points in or on geometries --------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="pnt_in_list"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.pnt_in_list">[docs]</a><span class="k">def</span> <span class="nf">pnt_in_list</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">pnts_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check to see if a point is in a list of points</span>

<span class="sd">    sum([(x, y) == tuple(i) for i in [p0, p1, p2, p3]]) &gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pnts_list</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">is_in</span></div>


<div class="viewcode-block" id="point_in_polygon"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.point_in_polygon">[docs]</a><span class="k">def</span> <span class="nf">point_in_polygon</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>  <span class="c1"># pnt_in_poly(pnt, poly):  #</span>
    <span class="sd">&quot;&quot;&quot;Point is in polygon. ## fix this and use pip from arraytools</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pnt</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">poly</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">]]</span>
        <span class="n">c_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">c_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">c_min</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">c_max</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_cal</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="n">q</span> <span class="o">+</span> <span class="n">y0</span>
            <span class="k">if</span> <span class="n">y_cal</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="pnt_on_seg"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.pnt_on_seg">[docs]</a><span class="k">def</span> <span class="nf">pnt_on_seg</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">seg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Orthogonal projection of a point onto a 2 point line segment.</span>
<span class="sd">    Returns the intersection point, if the point is between the segment end</span>
<span class="sd">    points, otherwise, it returns the distance to the closest endpoint.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pnt : array-like</span>
<span class="sd">        `x,y` coordinate pair as list or ndarray</span>
<span class="sd">    seg : array-like</span>
<span class="sd">        `from-to points`, of x,y coordinates as an ndarray or equivalent</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &gt;&gt;&gt; seg = np.array([[0, 0], [10, 10]])  # p0, p1</span>
<span class="sd">    &gt;&gt;&gt; p = [10, 0]</span>
<span class="sd">    &gt;&gt;&gt; pnt_on_seg(seg, p)</span>
<span class="sd">    array([5., 5.])</span>

<span class="sd">    Generically, with crossproducts and norms</span>

<span class="sd">    &gt;&gt;&gt; d = np.linalg.norm(np.cross(p1-p0, p0-p))/np.linalg.norm(p1-p0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="o">*</span><span class="n">pnt</span><span class="p">,</span> <span class="o">*</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dist_</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span><span class="o">*</span><span class="n">dy</span>  <span class="c1"># squared length</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">((</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span><span class="o">/</span><span class="n">dist_</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">])</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">-</span> <span class="n">pnt</span>
    <span class="k">return</span> <span class="n">xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="pnt_on_poly"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.pnt_on_poly">[docs]</a><span class="k">def</span> <span class="nf">pnt_on_poly</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find closest point location on a polygon/polyline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pnt : 1D ndarray array</span>
<span class="sd">        XY pair representing the point coordinates.</span>
<span class="sd">    poly : 2D ndarray array</span>
<span class="sd">        A sequence of XY pairs in clockwise order is expected.  The first and</span>
<span class="sd">        last points may or may not be duplicates, signifying sequence closure.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A list of [x, y, distance, angle] for the intersection point on the line.</span>
<span class="sd">    The angle is relative to north from the origin point to the point on the</span>
<span class="sd">    polygon.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    e_dist is represented by _e_2d and pnt_on_seg by its equivalent below.</span>
<span class="sd">    </span>
<span class="sd">    _line_dir_ is from it&#39;s equivalent line_dir included here.</span>

<span class="sd">    This may be as simple as finding the closest point on the edge, but if</span>
<span class="sd">    needed, an orthogonal projection onto a polygon/line edge will be done.</span>
<span class="sd">    This situation arises when the distance to two sequential points is the</span>
<span class="sd">    same</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_e_2d_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; array points to point distance... mini e_dist&quot;&quot;&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_pnt_on_seg_</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">pnt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mini pnt_on_seg function normally required by pnt_on_poly&quot;&quot;&quot;</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="o">*</span><span class="n">pnt</span><span class="p">,</span> <span class="o">*</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dist_</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span><span class="o">*</span><span class="n">dy</span>  <span class="c1"># squared length</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">((</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span><span class="o">/</span><span class="n">dist_</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># u must be between 0 and 1</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">])</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xy</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_line_dir_</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mini line direction function&quot;&quot;&quot;</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">-</span> <span class="n">orig</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dxy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dxy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ang</span>
    <span class="c1">#</span>
    <span class="n">pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pnt</span><span class="p">)</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">poly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># strip off any duplicate</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">poly</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># ---- determine the distances</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">_e_2d_</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">pnt</span><span class="p">)</span>  <span class="c1"># abbreviated edist =&gt;  d = e_dist(poly, pnt)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>         <span class="c1"># dist = d[key]</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">poly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="n">poly</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">poly</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">poly</span><span class="p">[:</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">poly</span><span class="p">[</span><span class="n">key</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">key</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>    <span class="c1"># grab the before and after closest</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">_pnt_on_seg_</span><span class="p">(</span><span class="n">seg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pnt</span><span class="p">)</span>  <span class="c1"># abbreviated pnt_on_seg</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n1</span> <span class="o">-</span> <span class="n">pnt</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">_pnt_on_seg_</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">pnt</span><span class="p">)</span>   <span class="c1"># abbreviated pnt_on_seg</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="n">pnt</span><span class="p">)</span>    
    <span class="k">if</span> <span class="n">d1</span> <span class="o">&lt;=</span> <span class="n">d2</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="p">[</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">_line_dir_</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="mf">450.0</span> <span class="o">-</span> <span class="n">ang</span><span class="p">),</span> <span class="mf">360.</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">d1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">ang</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="p">[</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">_line_dir_</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="mf">450.0</span> <span class="o">-</span> <span class="n">ang</span><span class="p">),</span> <span class="mf">360.</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">d2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">ang</span><span class="p">)]</span></div>


<span class="k">def</span> <span class="nf">p_o_p</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">polys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; main runner</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pnt_on_poly</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># ---- nearest neighbors, knn ------------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="knn"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.knn">[docs]</a><span class="k">def</span> <span class="nf">knn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnts</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates k nearest neighbours for a given point.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : array</span>
<span class="sd">        x,y reference point</span>
<span class="sd">    pnts : array</span>
<span class="sd">        Points array to examine</span>
<span class="sd">    k : integer</span>
<span class="sd">        The `k` in k-nearest neighbours</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Array of k-nearest points and optionally their distance from the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_remove_self_</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a point which is duplicated or itself from the array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">pnts</span> <span class="o">==</span> <span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pnts</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_e_2d_</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; array points to point distance... mini e_dist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnts</span><span class="p">)))</span>
    <span class="n">pnts</span> <span class="o">=</span> <span class="n">_remove_self_</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnts</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">_e_2d_</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnts</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_dist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pnts</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">k</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pnts</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">k</span><span class="p">]</span></div>


<div class="viewcode-block" id="nn_kdtree"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.nn_kdtree">[docs]</a><span class="k">def</span> <span class="nf">nn_kdtree</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sorted_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_tbl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_cKD</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Produce the N closest neighbours array with their distances using</span>
<span class="sd">    scipy.spatial.KDTree as an alternative to einsum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array</span>
<span class="sd">        Assumed to be an array of point objects for which `nearest` is needed.</span>
<span class="sd">    N : integer</span>
<span class="sd">        Number of neighbors to return.  Note: the point counts as 1, so N=3</span>
<span class="sd">        returns the closest 2 points, plus itself.</span>
<span class="sd">        For table output, max N is limited to 5 so that the tabular output</span>
<span class="sd">        isn&#39;t ridiculous.</span>
<span class="sd">    sorted_ : boolean</span>
<span class="sd">        A nice option to facilitate things.  See `xy_sort`.  Its mini-version</span>
<span class="sd">        is included in this function.</span>
<span class="sd">    to_tbl : boolean</span>
<span class="sd">        Produce a structured array output of coordinate pairs and distances.</span>
<span class="sd">    as_cKD : boolean</span>
<span class="sd">        Whether to use the `c` compiled or pure python version</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `&lt;https://stackoverflow.com/questions/52366421/how-to-do-n-d-distance-</span>
<span class="sd">    and-nearest-neighbor-calculations-on-numpy-arrays/52366706#52366706&gt;`_.</span>

<span class="sd">    `&lt;https://stackoverflow.com/questions/6931209/difference-between-scipy-</span>
<span class="sd">    spatial-kdtree-and-scipy-spatial-ckdtree/6931317#6931317&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_xy_sort_</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mini xy_sort&quot;&quot;&quot;</span>
        <span class="n">a_view</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a_view</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="n">a_view</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">idx</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">xy_dist_headers</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct headers for the optional table output&quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Y_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;d_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">))]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">cKDTree</span><span class="p">,</span> <span class="n">KDTree</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">sorted_</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_xy_sort_</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># ---- query the tree for the N nearest neighbors and their distance</span>
    <span class="k">if</span> <span class="n">as_cKD</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">dists</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># so that point isn&#39;t duplicated</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>               <span class="c1"># and the array is 2D</span>
    <span class="n">frumXY</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">to_tbl</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">xy_dist_headers</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># --- Format a structured array header</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">new_shp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">xys</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shp</span><span class="p">)</span>
        <span class="c1">#ds = dists[:, 1]  # [d[1:] for d in dists]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">frumXY</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">dists</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">z</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dists</span></div>


<span class="c1"># ---- mini stuff -----------------------------------------------------------</span>
<span class="c1">#</span>
<div class="viewcode-block" id="cross"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.cross">[docs]</a><span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cross-product for vectors o-a and o-b</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="n">o</span>
    <span class="n">xa</span><span class="p">,</span> <span class="n">ya</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">xa</span> <span class="o">-</span> <span class="n">xo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">yb</span> <span class="o">-</span> <span class="n">yo</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ya</span> <span class="o">-</span> <span class="n">yo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xb</span> <span class="o">-</span> <span class="n">xo</span><span class="p">)</span></div>


<div class="viewcode-block" id="e_2d"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.e_2d">[docs]</a><span class="k">def</span> <span class="nf">e_2d</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; array points to point distance... mini e_dist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span></div>


<div class="viewcode-block" id="remove_self"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.remove_self">[docs]</a><span class="k">def</span> <span class="nf">remove_self</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove a point which is duplicated or itself from the array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">pnts</span> <span class="o">==</span> <span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pnts</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span></div>


<div class="viewcode-block" id="adjacency_edge"><a class="viewcode-back" href="../../arraytools_mods.html#arraytools.geom.adjacency_edge">[docs]</a><span class="k">def</span> <span class="nf">adjacency_edge</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;keep... adjacency-edge list association</span>
<span class="sd">    : the columns are &#39;from&#39;, the rows are &#39;to&#39; the cell value is the &#39;weight&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
    <span class="c1"># dt = [(&#39;Source&#39;, &#39;&lt;i4&#39;), (&#39;Target&#39;, &#39;&lt;i4&#39;), (&#39;Weight&#39;, &#39;&lt;f8&#39;)]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="c1"># mmm = np.stack((m, m, m), axis=1)</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
    <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">YY</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">XX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">adj</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">frmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Adjacency edge list association...</span>
<span class="s2">    </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">    edge...</span>
<span class="s2">    (col, row, value)</span>
<span class="s2">    </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">frmt</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span></div>


<span class="c1"># ---- Extras ----------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_test</span><span class="p">(</span><span class="n">a0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;testing stuff using a0&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">if</span> <span class="n">a0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]])</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">=</span> <span class="n">a0</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">a0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mf">2.</span>
    <span class="n">xn</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>  <span class="c1"># dist / fact</span>
    <span class="n">yn</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>  <span class="c1"># dist / fact</span>
    <span class="c1"># better</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">step</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a0</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">x2</span>


<span class="c1"># ---- data and demos --------------------------------------------------------</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_arrs_</span><span class="p">(</span><span class="n">prn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample arrays to test various cases</span>
<span class="sd">    &quot;&quot;&quot;</span>
  <span class="c1"># capital C</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]])</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">],</span> <span class="p">[</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">],</span> <span class="p">[</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">],</span> <span class="p">[</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">],</span> <span class="p">[</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">]])</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">),</span> <span class="p">(</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">),</span> <span class="p">(</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)],</span>
                  <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">)])</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],),</span> <span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],),</span> <span class="p">([</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],),</span>
                   <span class="p">([</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],),</span> <span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],)],</span>
                  <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Shape&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))])</span>
    <span class="n">a_1a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a1</span><span class="p">])</span>
    <span class="n">a_1b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">a_2a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a2</span><span class="p">,</span> <span class="n">a2</span><span class="p">])</span>
    <span class="n">a_2b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a2</span><span class="p">,</span> <span class="n">a2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">a_3a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a3</span><span class="p">,</span> <span class="n">a3</span><span class="p">])</span>
    <span class="n">a_3b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">a3</span><span class="p">,</span> <span class="n">a3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">-</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">-</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a_1a</span><span class="p">,</span> <span class="n">a_1b</span><span class="p">,</span> <span class="n">a_2a</span><span class="p">,</span> <span class="n">a_2b</span><span class="p">,</span> <span class="n">a_3a</span><span class="p">,</span> <span class="n">a_3b</span><span class="p">]</span>
    <span class="n">sze</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="n">dtn</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prn</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a_1a</span><span class="p">,</span> <span class="n">a_1b</span><span class="p">,</span> <span class="n">a_2a</span><span class="p">,</span> <span class="n">a_2b</span><span class="p">,</span> <span class="n">a_3a</span><span class="p">,</span> <span class="n">a_3b</span><span class="p">,</span> <span class="n">cw</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a0&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a_1a&#39;</span><span class="p">,</span> <span class="s1">&#39;a_1b&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a_2a&#39;</span><span class="p">,</span> <span class="s1">&#39;a_2b&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a_3a&#39;</span><span class="p">,</span> <span class="s1">&#39;a_3b&#39;</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{!s:&lt;6}</span><span class="s2"> </span><span class="si">{!s:&lt;5}</span><span class="s2"> </span><span class="si">{!s:&lt;5}</span><span class="s2"> </span><span class="si">{!s:&lt;4}</span><span class="s2"> </span><span class="si">{!s:&lt;10}</span><span class="s2"> </span><span class="si">{!s:&lt;20}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">frmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">frmt</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sze</span><span class="p">,</span> <span class="n">shp</span><span class="p">,</span> <span class="n">dtn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_demo</span><span class="p">(</span><span class="n">prn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Demo the densify function using Ontario boundary polyline</span>
<span class="sd">    :</span>
<span class="sd">    : ---- Ontario boundary polyline, shape (49,874, 2) ----</span>
<span class="sd">    :  x = &quot;...script location.../Data/Ontario.npy&quot;</span>
<span class="sd">#   : a = np.load(x)</span>
<span class="sd">    : alternates... but slower</span>
<span class="sd">    : def PolyArea(x, y):</span>
<span class="sd">    :     return 0.5*np.abs(np.dot(x, np.roll(y,1))-np.dot(y, np.roll(x,1)))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;/Data/Ontario.npy&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">fact</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">_densify_2D</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">)</span>
    <span class="n">t0</span><span class="p">,</span> <span class="n">avl</span> <span class="o">=</span> <span class="n">e_leng</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># first is total, 2nd is all lengths</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="n">min_l</span> <span class="o">=</span> <span class="n">avl</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">avg_l</span> <span class="o">=</span> <span class="n">avl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">max_l</span> <span class="o">=</span> <span class="n">avl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">e_area</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">ar1</span> <span class="o">=</span> <span class="n">ar</span><span class="o">/</span><span class="mf">1.0e04</span>
    <span class="n">ar2</span> <span class="o">=</span> <span class="n">ar</span><span class="o">/</span><span class="mf">1.0e06</span>
    <span class="k">if</span> <span class="n">prn</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Original number of points... </span><span class="si">{:,}</span><span class="s2"></span>
<span class="s2">        Densified by a factor of ... </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">        New point count ............ </span><span class="si">{:,}</span><span class="s2"></span>
<span class="s2">        Ontario perimeter .......... </span><span class="si">{:,.1f}</span><span class="s2"> m  </span><span class="si">{:,.2f}</span><span class="s2"> km</span>
<span class="s2">        Segments lengths ... min  </span><span class="si">{:,.2f}</span><span class="s2"> m</span>
<span class="s2">                             mean </span><span class="si">{:,.2f}</span><span class="s2"> m</span>
<span class="s2">                             max  </span><span class="si">{:,.2f}</span><span class="s2"> m</span>
<span class="s2">        Ontario area ............... </span><span class="si">{:,.2f}</span><span class="s2"> ha.  </span><span class="si">{:,.1f}</span><span class="s2"> sq.km.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fact</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">min_l</span><span class="p">,</span>
                <span class="n">avg_l</span><span class="p">,</span> <span class="n">max_l</span><span class="p">,</span> <span class="n">ar1</span><span class="p">,</span> <span class="n">ar2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">frmt</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="c1"># ----------------------------------------------------------------------</span>
<span class="c1"># __main__ .... code section</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># print the script source name.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Script... </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>

<span class="c1"># sample array... big C and points</span>
<span class="c1">#c = np.array([[ 0, 0], [ 0, 1000], [1000, 1000], [1000,  800],</span>
<span class="c1">#              [ 200,  800], [ 200, 200], [1000, 200], [1000, 0], [ 0, 0]])</span>
<span class="c1"># pnts = np.random.randint(0, 1000, size=(1000,2))</span>

<span class="c1"># for Ontario_LCC</span>
<span class="c1"># total_length(a)  #: 6804096.2018476073  same as arcmap</span>
<span class="c1"># areas(a)  #: [1074121438784.0]  1074121438405.34021</span>

<span class="c1">#    from arraytools.fc_tools import fc</span>
<span class="c1">#    in_fc = r&#39;C:\Git_Dan\a_Data\arcpytools_demo.gdb\Can_geom_sp_LCC&#39;</span>
<span class="c1">#    in_fc = r&#39;C:\Git_Dan\a_Data\arcpytools_demo.gdb\Ontario_LCC&#39;</span>
<span class="c1">#    in_fc = r&quot;C:\Git_Dan\a_Data\arcpytools_demo.gdb\Carp_5x5&quot;   # full 25 polygons</span>
<span class="c1">#    a = fc._xy(in_fc)</span>
<span class="c1">#    a_s = group_pnts(a, key_fld=&#39;IDs&#39;, shp_flds=[&#39;Xs&#39;, &#39;Ys&#39;])</span>
<span class="c1">#    a_s = np.asarray(a_s)</span>
<span class="c1">#    a_area = areas(a_s)</span>
<span class="c1">#    a_tot_leng = total_length(a_s)</span>
<span class="c1">#    a_seg_leng = seg_lengths(a_s)</span>
<span class="c1">#    a_ng = angles_poly(a1)</span>
<span class="c1">#    v = r&#39;C:\Git_Dan\arraytools\Data\sample_100K.npy&#39;  # 20, 1000, 10k, 100K</span>
<span class="c1">#    oa = obj_array(in_fc)</span>
<span class="c1">#    ta = _two_arrays(in_fc, both=True, split=True)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">test for segment segment intersection</span>

<span class="sd">a = np.array([[0,0], [3,3]])</span>
<span class="sd">b = np.array([[0,3], [3,0]])</span>
<span class="sd">p0, p1, p2, p3 = *a, *b</span>
<span class="sd">x0, y0, x1, y1, x2, y2, x3, y3 = *p0, *p1, *p2, *p3</span>
<span class="sd">denom = (x1 - x0) * (y3 - y2) - (x3 - x2) * (y1 - y0)</span>
<span class="sd">denom_gt0 = denom &gt; 0</span>
<span class="sd">s_numer = (x1 - x0) * (y0 - y2) - (y1 - y0) * (x0 - x2)</span>
<span class="sd">(s_numer &lt; 0) == denom_gt0</span>
<span class="sd">t_numer = (x3 - x2) * (y0 - y2) - (y3 - y2) * (x0 - x2)</span>
<span class="sd">(t_numer &lt; 0) == denom_gt0</span>
<span class="sd">((s_numer &gt; denom) == denom_gt0) or ((t_numer &gt; denom) == denom_gt0)</span>
<span class="sd">t = t_numer / denom</span>
<span class="sd">x = x0 + t * (x1 - x0)</span>
<span class="sd">y = y0 + t * (y1 - y0)</span>
<span class="sd">print(&quot;intersecton pnt ({},{} t {})&quot;.format(x, y, t))</span>
<span class="sd">intersecton pnt (1.5,1.5 t 0.5)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Dan Patterson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>